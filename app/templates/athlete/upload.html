<!-- templates/athlete/upload.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä»Šæ—¥è¨“ç·´ä¸»é </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #FDFCF7;
      font-family: 'Noto Sans', sans-serif;
    }
    .container-narrow {
      max-width: 600px;
      margin: auto;
    }
    .navbar-custom {
      background-color: #F9C300;
    }
    .navbar-custom .navbar-brand {
      font-weight: 700;
      color: #1a1a1a;
    }
    .card-yellow {
      background-color: #FFFBE6;
      border: none;
      border-radius: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .card-yellow:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .card-header {
      background: none;
      border-bottom: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .icon-circle {
      width: 36px;
      height: 36px;
      background-color: #F9C300;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: #1a1a1a;
    }
    .btn-yellow {
      background-color: #F9C300;
      color: #1a1a1a;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .btn-yellow:hover {
      background-color: #e5b100;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h4>ä»Šæ—¥è¨“ç·´ä¸»é </h4>

    <!-- Flash è¨Šæ¯é¡¯ç¤º -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- æ—¥æœŸé¸æ“‡å™¨ -->
    <div class="card card-yellow p-3 mb-4">
      <div class="d-flex align-items-center mb-2">
        <div class="icon-circle">ğŸ“…</div>
        <div><strong>é¸æ“‡æ—¥æœŸ</strong></div>
      </div>
      <input type="text" id="datePicker" class="form-control" value="{{ current_date }}" />
    </div>

    <form method="POST" action="/training/today/save">
      <input type="hidden" name="selected_date" value="{{ current_date }}" />

      <!-- æ•™ç·´æ´¾ç™¼é«”èƒ½ -->
      <div class="card card-yellow mb-4">
        <div class="card-header">
          <div class="icon-circle">ğŸ’ª</div> æ•™ç·´æ´¾ç™¼é«”èƒ½è¨“ç·´
        </div>
        <div class="card-body">
          {% if record and record.coach_assigned_physical %}
            <p>{{ record.coach_assigned_physical }}</p>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="coach_physical_done" value="on"
              {% if record.coach_physical_done %}checked{% endif %}/>
              <label class="form-check-label">æˆ‘å·²å®Œæˆæ­¤é«”èƒ½è¨“ç·´</label>
            </div>
          {% else %}
            <p class="text-muted">ä»Šæ—¥ç„¡æ´¾ç™¼é«”èƒ½è¨“ç·´</p>
          {% endif %}
        </div>
      </div>

      <!-- æ•™ç·´æ´¾ç™¼æŠ€å·§ -->
      <div class="card card-yellow mb-4">
        <div class="card-header">
          <div class="icon-circle">ğŸ¸</div> æ•™ç·´æ´¾ç™¼æŠ€å·§è¨“ç·´
        </div>
        <div class="card-body">
          {% if record and record.coach_assigned_technical %}
            <ul>
              {% for item in record.coach_assigned_technical | from_json %}
              <li>[{{ item.category }}] {{ item.topic }} ({{ item.duration_or_reps }}) - {{ item.focus }}</li>
              {% endfor %}
            </ul>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="coach_technical_done" value="on"
              {% if record.coach_technical_done %}checked{% endif %}/>
              <label class="form-check-label">æˆ‘å·²å®Œæˆæ­¤æŠ€å·§è¨“ç·´</label>
            </div>
          {% else %}
            <p class="text-muted">ä»Šæ—¥ç„¡æ´¾ç™¼æŠ€å·§è¨“ç·´</p>
          {% endif %}
        </div>
      </div>

      <!-- ä¸»å‹•å¡«å¯«æŒ‰éˆ• -->
      <div class="d-grid gap-2 mb-3">
        <button class="btn btn-outline-dark" type="button" data-bs-toggle="modal" data-bs-target="#modalPhysical">
          âœï¸ ä¸»å‹•å¡«å¯«ï¼šé«”èƒ½è¨“ç·´ç´€éŒ„
        </button>
        <button class="btn btn-outline-dark" type="button" data-bs-toggle="modal" data-bs-target="#modalTechnical">
          âœï¸ ä¸»å‹•å¡«å¯«ï¼šæŠ€å·§è¨“ç·´ç´€éŒ„
        </button>
      </div>

      <!-- ä¸»å‹•å¡«å¯«çš„å…§å®¹ -->
      <div class="card card-yellow mb-4">
        <div class="card-header">
          <div class="icon-circle">âœ…</div> æˆ‘è‡ªå·±å¡«å¯«çš„è¨“ç·´ç´€éŒ„
        </div>
        <div class="card-body">
          {% if record and (record.jump_type or record.jump_count or record.run_distance or record.run_time or record.weight_sets or record.agility_type or record.agility_note) %}
            <p><strong>é«”èƒ½è¨“ç·´ï¼š</strong>
              {{ record.jump_type or '' }}ï¼Œ
              {{ record.jump_count or '' }} æ¬¡ï¼Œ
              è·‘æ­¥ {{ record.run_distance or '' }}km / {{ record.run_time or '' }}minï¼Œ
              é‡é‡ï¼š{{ record.weight_sets or '' }}ï¼Œ
              æ•æ·ï¼š{{ record.agility_type or '' }}ï¼Œ
              å‚™è¨»ï¼š{{ record.agility_note or '' }}
            </p>
          {% else %}
            <p class="text-muted">å°šæœªå¡«å¯«é«”èƒ½è¨“ç·´</p>
          {% endif %}

          {% set technical_items = record.technical_items | from_json %}
          {% if technical_items %}
            <ul>
              {% for item in technical_items %}
              <li>[{{ item.category }}] {{ item.topic }} ({{ item.duration_or_reps }}) - {{ item.focus }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">å°šæœªå¡«å¯«æŠ€å·§è¨“ç·´</p>
          {% endif %}
        </div>
      </div>

      <!-- æœ€çµ‚é€å‡º -->
      <div class="text-center mb-4">
        <button class="btn btn-yellow px-5 py-2" type="submit">ğŸ’¾ å„²å­˜ä»Šæ—¥æ‰€æœ‰è¨“ç·´ç´€éŒ„</button>
      </div>

      <!-- è¿”å›å­¸ç”Ÿç«¯ -->
      <div class="text-center mt-3">
        <a href="/athlete/dashboard" class="btn btn-secondary">â† è¿”å›å­¸ç”Ÿç«¯</a>
      </div>

      <!-- è¿”å›å­¸ç”Ÿç«¯ -->
      <div class="text-center mt-3">
        <a href="/athlete/dashboard" class="btn btn-secondary">â† è¿”å›å­¸ç”Ÿç«¯</a>
      </div>

      <!-- Modal: é«”èƒ½è¨“ç·´ -->
      <div class="modal fade" id="modalPhysical" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header"><h5>é«”èƒ½è¨“ç·´ç´€éŒ„</h5></div>
            <div class="modal-body">
              <div class="mb-2">
                <label for="jump_type">è·³ç¹©ç¨®é¡</label>
                <select name="jump_type" id="jump_type" class="form-control" required>
                  <option value="" disabled {{ 'selected' if not record.jump_type }}>è«‹é¸æ“‡è·³ç¹©ç¨®é¡</option>
                  <option value="Basic" {{ 'selected' if record.jump_type == 'Basic' }}>åŸºæœ¬ç¹©</option>
                  <option value="Speed" {{ 'selected' if record.jump_type == 'Speed' }}>é€Ÿåº¦ç¹©</option>
                  <option value="Weighted" {{ 'selected' if record.jump_type == 'Weighted' }}>é‡é‡ç¹©</option>
                  <option value="Freestyle" {{ 'selected' if record.jump_type == 'Freestyle' }}>èŠ±å¼ç¹©</option>
                </select>
              </div>

              <div class="mb-2">
                <label>è·³ç¹©æ¬¡æ•¸</label>
                <input
                  type="number"
                  name="jump_count"
                  class="form-control"
                  value="{{ record.jump_count or '' }}"
                />
              </div>
              <div class="mb-2">
                <label>è·‘æ­¥è·é›¢</label>
                <input
                  type="text"
                  name="run_distance"
                  class="form-control"
                  value="{{ record.run_distance or '' }}"
                />
              </div>
              <div class="mb-2">
                <label>è·‘æ­¥æ™‚é–“</label>
                <input
                  type="text"
                  name="run_time"
                  class="form-control"
                  value="{{ record.run_time or '' }}"
                />
              </div>
              <div class="mb-2">
                <label>é‡é‡è¨“ç·´</label>
                <input
                  type="text"
                  name="weight_sets"
                  class="form-control"
                  value="{{ record.weight_sets or '' }}"
                />
              </div>
              <div class="mb-2">
                <label>æ•æ·è¨“ç·´</label>
                <input
                  type="text"
                  name="agility_type"
                  class="form-control"
                  value="{{ record.agility_type or '' }}"
                />
              </div>
              <div class="mb-2">
                <label>å‚™è¨»</label>
                <textarea name="agility_note" class="form-control">{{ record.agility_note or '' }}</textarea>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ç¢ºèª</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: æŠ€å·§è¨“ç·´ -->
      <div class="modal fade" id="modalTechnical" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header"><h5>æŠ€å·§è¨“ç·´ç´€éŒ„</h5></div>
            <div class="modal-body">
              <div class="mb-3"><label>è¨“ç·´æ¨™é¡Œ</label><input type="text" name="technical_title" class="form-control" value="{{ record.technical_title or '' }}"/></div>
              <table class="table table-bordered" id="tech-table">
                <thead><tr><th>é¡å‹</th><th>ä¸»é¡Œ</th><th>æ¬¡æ•¸/æ™‚é–“</th><th>é‡é»</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                  {% set technical_items = record.technical_items | from_json %}
                  {% if technical_items %}
                    {% for item in technical_items %}
                      <tr>
                        <td>
                          <select name="category[]" class="form-select">
                            <option value="å–®çƒ" {% if item.category == 'å–®çƒ' %}selected{% endif %}>å–®çƒ</option>
                            <option value="å¤šçƒ" {% if item.category == 'å¤šçƒ' %}selected{% endif %}>å¤šçƒ</option>
                            <option value="ç™¼çƒ" {% if item.category == 'ç™¼çƒ' %}selected{% endif %}>ç™¼çƒ</option>
                          </select>
                        </td>
                        <td><input type="text" name="topic[]" class="form-control" value="{{ item.topic }}" /></td>
                        <td><input type="text" name="duration[]" class="form-control" value="{{ item.duration_or_reps }}" /></td>
                        <td><input type="text" name="focus[]" class="form-control" value="{{ item.focus }}" /></td>
                        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeTechRow(this)">åˆªé™¤</button></td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td>
                        <select name="category[]" class="form-select">
                          <option value="å–®çƒ">å–®çƒ</option>
                          <option value="å¤šçƒ">å¤šçƒ</option>
                          <option value="ç™¼çƒ">ç™¼çƒ</option>
                        </select>
                      </td>
                      <td><input type="text" name="topic[]" class="form-control" /></td>
                      <td><input type="text" name="duration[]" class="form-control" /></td>
                      <td><input type="text" name="focus[]" class="form-control" /></td>
                      <td><button type="button" class="btn btn-danger btn-sm" onclick="removeTechRow(this)">åˆªé™¤</button></td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
              <button type="button" class="btn btn-secondary mb-3" onclick="addTechRow()">æ–°å¢è¨“ç·´é …ç›®</button>
              <div class="mb-2"><label>å¿ƒå¾—</label><textarea name="technical_feedback" class="form-control">{{ record.technical_feedback or '' }}</textarea></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="technical_completed" value="on" {% if record.technical_completed %}checked{% endif %}/> <label class="form-check-label">æˆ‘å·²å®Œæˆæ­¤æŠ€å·§è¨“ç·´</label></div>
              <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ç¢ºèª</button></div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    flatpickr("#datePicker", {
      dateFormat: "Y-m-d",
      defaultDate: "{{ current_date }}",
      onChange: function (selectedDates, dateStr, instance) {
        window.location.href = "/training/today?date=" + dateStr;
      },
    });
    function addTechRow() {
      const row = document.querySelector("#tech-table tbody tr").cloneNode(true);
      row.querySelectorAll("input").forEach((input) => (input.value = ""));
      row.querySelectorAll("select").forEach((select) => (select.selectedIndex = 0));
      document.querySelector("#tech-table tbody").appendChild(row);
    }
    function removeTechRow(button) {
      const row = button.closest("tr");
      const tbody = document.querySelector("#tech-table tbody");
      if (tbody.rows.length > 1) row.remove();
    }
  </script>
</body>
</html>

