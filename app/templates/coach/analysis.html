<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•™ç·´ç«¯ - ä»»å‹™åˆ†æ</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}?v={{ range(1000)|random }}" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background-color: #f8f9fa; }
  .card { border-radius: 15px; }
  .table th, .table td { vertical-align: middle; }
</style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center text-primary mb-4">ğŸ“Š å­¸ç”Ÿè¨“ç·´åˆ†æ</h2>

    <!-- ä»»å‹™å®Œæˆåœ–è¡¨ -->
    <div class="card p-4 shadow-sm mb-4">
        <canvas id="completionChart" height="180"></canvas>
    </div>

    <!-- ä»»å‹™æ˜ç´°è¡¨ -->
    <div class="card p-4 shadow-sm">
        <h5>æ•¸æ“šæ˜ç´°</h5>
        <table class="table table-striped table-hover mt-3">
            <thead>
                <tr>
                    <th>å­¸ç”Ÿ</th>
                    <th>é«”èƒ½å·²å®Œæˆ / ç¸½æ•¸</th>
                    <th>æŠ€å·§å·²å®Œæˆ / ç¸½æ•¸</th>
                    <th>ç¸½å®Œæˆç‡ (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for s in stats %}
                <tr>
                    <td>{{ s.full_name or s.username }}</td>
                    <td>{{ s.strength_completed or 0 }} / {{ s.strength_total }}</td>
                    <td>{{ s.skill_completed or 0 }} / {{ s.skill_total }}</td>
                    <td>{{ ((s.total_completed or 0)/s.total*100)|round(1) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Jinja2 -> JS ä½¿ç”¨ tojson
const labels = {{ stats|map(attribute='full_name')|list|tojson }};
const strengthTotal = {{ stats|map(attribute='strength_total')|list|tojson }};
const strengthCompleted = {{ stats|map(attribute='strength_completed')|list|tojson }};
const skillTotal = {{ stats|map(attribute='skill_total')|list|tojson }};
const skillCompleted = {{ stats|map(attribute='skill_completed')|list|tojson }};

// ç¸½å®Œæˆç‡
const totalCompleted = {{ stats|map(attribute='total_completed')|list|tojson }};
const totalTasks = {{ stats|map(attribute='total')|list|tojson }};
const completionRate = totalCompleted.map((v,i) => (v/totalTasks[i]*100).toFixed(1));

const ctx = document.getElementById('completionChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'é«”èƒ½ç¸½æ•¸',
                data: strengthTotal,
                backgroundColor: 'rgba(0,123,255,0.3)',
                borderColor: 'rgba(0,123,255,1)',
                borderWidth: 1
            },
            {
                label: 'é«”èƒ½å·²å®Œæˆ',
                data: strengthCompleted,
                backgroundColor: 'rgba(0,123,255,0.7)',
                borderColor: 'rgba(0,123,255,1)',
                borderWidth: 1
            },
            {
                label: 'æŠ€å·§ç¸½æ•¸',
                data: skillTotal,
                backgroundColor: 'rgba(40,167,69,0.3)',
                borderColor: 'rgba(40,167,69,1)',
                borderWidth: 1
            },
            {
                label: 'æŠ€å·§å·²å®Œæˆ',
                data: skillCompleted,
                backgroundColor: 'rgba(40,167,69,0.7)',
                borderColor: 'rgba(40,167,69,1)',
                borderWidth: 1
            },
            {
                label: 'ç¸½å®Œæˆç‡ (%)',
                data: completionRate,
                type: 'line',
                yAxisID: 'y1',
                borderColor: 'rgba(255,193,7,1)',
                backgroundColor: 'rgba(255,193,7,0.2)',
                tension: 0.3,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: { 
            title: { display: true, text: 'å­¸ç”Ÿä»»å‹™å®Œæˆç‹€æ³ï¼ˆé«”èƒ½ / æŠ€å·§ï¼‰' }, 
            legend: { position: 'top' } 
        },
        scales: {
            y: {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: { display: true, text: 'ä»»å‹™æ•¸' }
            },
            y1: {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                max: 100,
                title: { display: true, text: 'å®Œæˆç‡ (%)' },
                grid: { drawOnChartArea: false }
            }
        }
    }
});
</script>
</body>
</html>
