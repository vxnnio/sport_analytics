<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教練端 - 任務分析</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}?v={{ range(1000)|random }}" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background-color: #f8f9fa; }
  .card { border-radius: 15px; }
  .table th, .table td { vertical-align: middle; }
</style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center text-primary mb-4">📊 學生訓練分析</h2>

    <!-- 任務完成圖表 -->
    <div class="card p-4 shadow-sm mb-4">
        <canvas id="completionChart" height="180"></canvas>
    </div>

    <!-- 任務明細表 -->
    <div class="card p-4 shadow-sm">
        <h5>數據明細</h5>
        <table class="table table-striped table-hover mt-3">
            <thead>
                <tr>
                    <th>學生</th>
                    <th>體能已完成 / 總數</th>
                    <th>技巧已完成 / 總數</th>
                    <th>總完成率 (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for s in stats %}
                <tr>
                    <td>{{ s.full_name or s.username }}</td>
                    <td>{{ s.strength_completed or 0 }} / {{ s.strength_total }}</td>
                    <td>{{ s.skill_completed or 0 }} / {{ s.skill_total }}</td>
                    <td>{{ ((s.total_completed or 0)/s.total*100)|round(1) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Jinja2 -> JS 使用 tojson
const labels = {{ stats|map(attribute='full_name')|list|tojson }};
const strengthTotal = {{ stats|map(attribute='strength_total')|list|tojson }};
const strengthCompleted = {{ stats|map(attribute='strength_completed')|list|tojson }};
const skillTotal = {{ stats|map(attribute='skill_total')|list|tojson }};
const skillCompleted = {{ stats|map(attribute='skill_completed')|list|tojson }};

// 總完成率
const totalCompleted = {{ stats|map(attribute='total_completed')|list|tojson }};
const totalTasks = {{ stats|map(attribute='total')|list|tojson }};
const completionRate = totalCompleted.map((v,i) => (v/totalTasks[i]*100).toFixed(1));

const ctx = document.getElementById('completionChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            {
                label: '體能總數',
                data: strengthTotal,
                backgroundColor: 'rgba(0,123,255,0.3)',
                borderColor: 'rgba(0,123,255,1)',
                borderWidth: 1
            },
            {
                label: '體能已完成',
                data: strengthCompleted,
                backgroundColor: 'rgba(0,123,255,0.7)',
                borderColor: 'rgba(0,123,255,1)',
                borderWidth: 1
            },
            {
                label: '技巧總數',
                data: skillTotal,
                backgroundColor: 'rgba(40,167,69,0.3)',
                borderColor: 'rgba(40,167,69,1)',
                borderWidth: 1
            },
            {
                label: '技巧已完成',
                data: skillCompleted,
                backgroundColor: 'rgba(40,167,69,0.7)',
                borderColor: 'rgba(40,167,69,1)',
                borderWidth: 1
            },
            {
                label: '總完成率 (%)',
                data: completionRate,
                type: 'line',
                yAxisID: 'y1',
                borderColor: 'rgba(255,193,7,1)',
                backgroundColor: 'rgba(255,193,7,0.2)',
                tension: 0.3,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: { 
            title: { display: true, text: '學生任務完成狀況（體能 / 技巧）' }, 
            legend: { position: 'top' } 
        },
        scales: {
            y: {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: { display: true, text: '任務數' }
            },
            y1: {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                max: 100,
                title: { display: true, text: '完成率 (%)' },
                grid: { drawOnChartArea: false }
            }
        }
    }
});
</script>
</body>
</html>
